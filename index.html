<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å’–å•¡å› ä»£è°¢è®¡ç®—å™¨ (Process S ç§‘å­¦æ¨¡å‹ç‰ˆ)</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* åˆ—è¡¨è¿›å…¥åŠ¨ç”» */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }
        .tab-active { background-color: #F5F5F4; border-bottom: 2px solid #6F4E37; color: #6F4E37; font-weight: bold; }
        .tab-inactive { color: #A8A29E; }
        /* è‡ªå®šä¹‰æ»‘å— */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #6F4E37; cursor: pointer; margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #E7E5E4; border-radius: 2px;
        }
        /* Toast & Modal åŠ¨ç”» */
        .toast-enter { opacity: 0; transform: translate(-50%, -20px); }
        .toast-enter-active { opacity: 1; transform: translate(-50%, 0); transition: all 0.3s ease-out; }
        .toast-exit { opacity: 1; transform: translate(-50%, 0); }
        .toast-exit-active { opacity: 0; transform: translate(-50%, -20px); transition: all 0.3s ease-in; }
    </style>
</head>
<body class="bg-stone-100 text-stone-800 min-h-screen flex items-center justify-center p-4">

    <!-- å…¨å±€æç¤ºæ¡† (Toast) -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-stone-800 text-white px-6 py-3 rounded-full shadow-xl z-50 hidden flex items-center gap-2">
        <span id="toastIcon">âš ï¸</span>
        <span id="toastMsg">æç¤ºä¿¡æ¯</span>
    </div>

    <!-- ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-100">
            <h3 class="text-lg font-bold text-stone-800 mb-2">ç”Ÿæˆæ™ºèƒ½æ–¹æ¡ˆï¼Ÿ</h3>
            <p class="text-sm text-stone-500 mb-6">ç³»ç»Ÿå°†ä¼˜å…ˆè§„åˆ’<b>æ ‡å‡†å•æ¯</b>è¡¥ç»™ã€‚è‹¥åç»­æ—¶é—´ç‚¹å› ç¡çœ é™åˆ¶æ— æ³•è¡¥ç»™ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å°è¯•<b>å¢åŠ å‰æœŸè¡¥ç»™çš„æµ“åº¦ï¼ˆ+0.5å€ï¼‰</b>æ¥ç»´æŒçŠ¶æ€ã€‚</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-stone-500 hover:bg-stone-100 rounded-lg transition-colors font-medium text-sm">å–æ¶ˆ</button>
                <button id="confirmActionBtn" class="px-4 py-2 bg-[#6F4E37] text-white rounded-lg hover:bg-[#5a3e2b] transition-colors font-medium text-sm shadow-md">ç¡®å®šç”Ÿæˆ</button>
            </div>
        </div>
    </div>

    <div class="max-w-2xl w-full bg-white rounded-2xl shadow-xl overflow-hidden border border-stone-200">
        
        <!-- å¤´éƒ¨ -->
        <div class="bg-[#6F4E37] p-6 text-white text-center relative">
            <h1 class="text-2xl font-bold tracking-wider">ğŸ§  è„‘åŠ› & å’–å•¡å› ç›‘æ§</h1>
            <p class="text-[#D2B48C] text-sm mt-1">Process S ç–²åŠ³ä¿®æ­£ + æ™ºèƒ½å›å¡«è§„åˆ’</p>
        </div>

        <div class="p-6 space-y-6">
            
            <!-- è®¾ç½®åŒºåŸŸ -->
            <div class="bg-stone-50 p-4 rounded-xl border border-stone-100 space-y-5">
                <!-- åŸºç¡€ç”Ÿç†å‚æ•° -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-stone-500 mb-1">ä»£è°¢åŠè¡°æœŸ</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="halfLife" min="3" max="10" step="0.5" value="5" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-[#6F4E37]">
                            <span id="halfLifeDisplay" class="text-[#6F4E37] font-bold text-sm">5.0h</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-stone-500 mb-1">â˜€ï¸ ä»Šæ—¥èµ·åºŠæ—¶é—´</label>
                        <input type="time" id="wakeUpTime" onchange="saveData();updateAnalysis();" value="07:30" class="w-full p-1 bg-white border border-stone-300 rounded text-sm text-center focus:ring-1 focus:ring-[#6F4E37] outline-none">
                    </div>
                </div>

                <!-- æç¥åŒºé—´è®¾ç½® -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-stone-500 uppercase">ğŸ§  ç›®æ ‡æç¥å¼ºåº¦ (mg)</span>
                    </div>
                    
                    <div class="relative h-3 w-full bg-stone-200 rounded-full mb-3 overflow-hidden">
                        <div id="visualZoneBar" class="absolute top-0 h-full bg-green-400 opacity-60 transition-all duration-300" style="left: 16%; width: 34%;"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="flex justify-between text-xs text-stone-500 mb-1">
                                <span>æœ€ä½æœ‰æ•ˆ (Perceived)</span>
                                <span class="font-bold text-[#6F4E37]"><span id="lblMinInput">80</span></span>
                            </label>
                            <input type="range" id="minFocusSlider" min="0" max="400" step="10" value="80" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer" oninput="syncSliders('min')">
                        </div>
                        <div>
                            <label class="flex justify-between text-xs text-stone-500 mb-1">
                                <span>ç„¦è™‘è­¦æˆ’ (Max)</span>
                                <span class="font-bold text-red-500"><span id="lblMaxInput">250</span></span>
                            </label>
                            <input type="range" id="maxFocusSlider" min="0" max="500" step="10" value="250" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer" oninput="syncSliders('max')">
                        </div>
                    </div>
                    
                    <input type="hidden" id="minFocus" value="80">
                    <input type="hidden" id="maxFocus" value="250">
                </div>
            </div>

            <!-- ç–²åŠ³åº¦ä»ªè¡¨ç›˜ -->
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-bold text-blue-900">å¤§è„‘è…ºè‹·å †ç§¯ (Process S)</h3>
                    <p class="text-xs text-blue-500 mt-1">æ¸…é†’ <span id="hoursAwakeDisplay">0</span>hï¼Œå’–å•¡å› æ•ˆåŠ› <span id="efficiencyDisplay" class="font-bold">100%</span></p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-blue-600" id="fatigueLevelDisplay">0%</div>
                    <div class="text-[10px] text-blue-400">ç–²åŠ³åº¦</div>
                </div>
            </div>

            <!-- æ™ºèƒ½è¡¥å’–åŠ©æ‰‹ -->
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 shadow-sm relative overflow-hidden">
                <div class="flex items-center gap-2 mb-3 relative z-10">
                    <span class="text-lg">ğŸ¤–</span>
                    <h3 class="text-sm font-bold text-indigo-900">æ™ºèƒ½ç–²åŠ³å¯¹æŠ—è§„åˆ’</h3>
                </div>
                
                <p class="text-xs text-indigo-600 mb-3">
                    ç­–ç•¥ï¼š<b>ä¸€æ¬¡ä¸€æ¯ï¼Œå¹³ç¨³ç»´æŒ</b>ã€‚è‹¥åç»­å› ç¡çœ é™åˆ¶æ— æ³•è¡¥ç»™ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æŸ¥æ‰¾å‰æœŸè®°å½•å¹¶<b>åŠ é‡åŠæ¯</b>ã€‚
                </p>

                <!-- æ¯æ¬¡è¡¥ç»™è®¾ç½®åŒº -->
                <div class="bg-white/60 p-3 rounded-lg border border-indigo-100 mb-3 relative z-10">
                    <label class="text-xs text-indigo-500 block mb-1 font-medium flex justify-between">
                        <span>æ¯æ¬¡è¡¥ç»™ (1æ ‡å‡†å•ä½)</span>
                        <span class="text-indigo-400 font-normal">1ä»½ â‰ˆ <span id="smartDoseDisplay" class="font-bold text-indigo-700">83</span> mg</span>
                    </label>
                    <div class="flex gap-2">
                        <select id="smartDrinkType" onchange="calcSmartDose();saveData();" class="flex-grow p-2 bg-white border border-indigo-200 rounded text-sm text-indigo-900 outline-none">
                            <option value="0.55">â˜• ç¾å¼ (é»‘å’–)</option>
                            <option value="0.40">ğŸ¥› æ‹¿é“ (å¥¶å’–)</option>
                            <option value="2.10">â˜• æµ“ç¼© (Espresso)</option>
                            <option value="1.00">ğŸ§Š å†·èƒå’–å•¡</option>
                            <option value="0.32">âš¡ èƒ½é‡é¥®æ–™</option>
                        </select>
                        <div class="relative w-20 flex-shrink-0">
                            <input type="number" id="smartDrinkVolume" value="150" oninput="calcSmartDose();saveData();" class="w-full p-2 bg-white border border-indigo-200 rounded text-sm text-indigo-900 text-center outline-none">
                            <span class="absolute right-1 top-2 text-xs text-indigo-300 pointer-events-none">ml</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3 relative z-10">
                    <div>
                        <label class="text-xs text-indigo-500 block mb-1 font-medium">ç»´æŒçŠ¶æ€ç›´åˆ°</label>
                        <input type="time" id="smartFocusEndTime" onchange="saveData()" value="18:00" class="w-full p-2 bg-white border border-indigo-200 rounded text-sm text-indigo-900 text-center outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-indigo-500 block mb-1 font-medium">é¢„è®¡å…¥ç¡</label>
                        <input type="time" id="smartSleepTime" onchange="saveData()" value="23:00" class="w-full p-2 bg-white border border-indigo-200 rounded text-sm text-indigo-900 text-center outline-none">
                    </div>
                </div>

                <button onclick="tryGenerateSmartPlan()" class="relative z-10 w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2.5 rounded-lg transition-all shadow-md active:scale-95 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    ç”Ÿæˆå¹³ç¨³ç»´æŒæ–¹æ¡ˆ
                </button>
            </div>

            <!-- æ‰‹åŠ¨æ·»åŠ åŒº -->
            <div class="border-t border-stone-100 pt-4" id="manualAddSection">
                <h3 class="text-sm font-bold text-stone-700 mb-3">æ‰‹åŠ¨è®°å½•</h3>
                
                <div class="mb-4">
                    <label class="text-xs font-medium text-stone-400 mb-1 block">é¥®ç”¨æ—¶é—´</label>
                    <input type="time" id="drinkTime" class="w-full p-3 bg-stone-50 border border-stone-300 rounded-lg focus:ring-2 focus:ring-[#6F4E37] outline-none">
                </div>

                <div class="flex border-b border-stone-200 mb-4">
                    <button id="tabMg" onclick="switchTab('mg')" class="flex-1 py-2 text-xs md:text-sm transition-all tab-active">ç›´æ¥è¾“å…¥ (mg)</button>
                    <button id="tabMl" onclick="switchTab('ml')" class="flex-1 py-2 text-xs md:text-sm transition-all tab-inactive">æŒ‰æ¶²ä½“ (ml)</button>
                    <button id="tabPowder" onclick="switchTab('powder')" class="flex-1 py-2 text-xs md:text-sm transition-all tab-inactive">æŒ‰ç²‰/è±† (g)</button>
                </div>

                <div id="modeMg" class="block mode-panel">
                    <div class="relative mb-3">
                        <input type="number" id="caffeineAmount" placeholder="å«é‡ (mg)" class="w-full p-3 pl-4 pr-12 bg-stone-50 border border-stone-300 rounded-lg focus:ring-2 focus:ring-[#6F4E37] outline-none font-semibold">
                        <span class="absolute right-4 top-3.5 text-stone-400 text-sm">mg</span>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="setAmount(40)" class="px-3 py-1 bg-stone-100 hover:bg-stone-200 text-stone-600 rounded-full text-xs transition">ğŸ¥¤ å¯ä¹ 40</button>
                        <button onclick="setAmount(95)" class="px-3 py-1 bg-amber-50 hover:bg-amber-100 text-amber-800 border border-amber-200 rounded-full text-xs transition font-medium">â˜• ç¾å¼ 95</button>
                        <button onclick="setAmount(180)" class="px-3 py-1 bg-stone-100 hover:bg-stone-200 text-stone-600 rounded-full text-xs transition">ğŸ§Š å¤§æ¯å†·èƒ 180</button>
                    </div>
                </div>

                <div id="modeMl" class="hidden mode-panel">
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="text-xs text-stone-400 block mb-1">é¥®å“ç±»å‹</label>
                            <select id="drinkTypeMl" onchange="calcFromVolume()" class="w-full p-3 bg-stone-50 border border-stone-300 rounded-lg focus:ring-2 focus:ring-[#6F4E37] outline-none text-sm">
                                <option value="0.55">â˜• å¸¸è§ç¾å¼/é»‘å’–</option>
                                <option value="0.40">ğŸ¥› æ‹¿é“/å¥¶å’–</option>
                                <option value="2.10">â˜• æµ“ç¼© (Espresso)</option>
                                <option value="1.00">ğŸ§Š å†·èƒå’–å•¡</option>
                                <option value="0.32">âš¡ èƒ½é‡é¥®æ–™</option>
                                <option value="0.20">ğŸµ èŒ¶ç±»</option>
                                <option value="0.10">ğŸ¥¤ å¯ä¹/è½¯é¥®</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-stone-400 block mb-1">æ¶²ä½“å®¹é‡</label>
                            <div class="relative">
                                <input type="number" id="volumeInput" placeholder="ä¾‹å¦‚: 350" oninput="calcFromVolume()" class="w-full p-3 pl-3 pr-10 bg-stone-50 border border-stone-300 rounded-lg focus:ring-2 focus:ring-[#6F4E37] outline-none">
                                <span class="absolute right-3 top-3 text-stone-400 text-sm">ml</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-amber-50 text-amber-900 px-4 py-2 rounded-lg text-sm mb-4 flex justify-between items-center border border-amber-100">
                        <span>é¢„ä¼°å«é‡ï¼š</span>
                        <span class="font-bold text-lg"><span id="estimatedMgMl">0</span> <span class="text-xs font-normal">mg</span></span>
                    </div>
                </div>

                <div id="modePowder" class="hidden mode-panel">
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="text-xs text-stone-400 block mb-1">åŸæ–™ç±»å‹</label>
                            <select id="powderType" onchange="calcFromPowder()" class="w-full p-3 bg-stone-50 border border-stone-300 rounded-lg focus:ring-2 focus:ring-[#6F4E37] outline-none text-sm">
                                <option value="35">ğŸ“¦ é€Ÿæº¶/å†»å¹²ç²‰</option>
                                <option value="10">ğŸ«˜ ç°ç£¨è±†/æ‰‹å†²ç²‰</option>
                                <option value="55">ğŸ’Š èƒ¶å›Š (æ¯é¢—)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-stone-400 block mb-1">ç”¨é‡ (å…‹/é¢—)</label>
                            <div class="relative">
                                <input type="number" id="powderInput" placeholder="ä¾‹å¦‚: 2" oninput="calcFromPowder()" class="w-full p-3 pl-3 pr-10 bg-stone-50 border border-stone-300 rounded-lg focus:ring-2 focus:ring-[#6F4E37] outline-none">
                                <span class="absolute right-3 top-3 text-stone-400 text-sm">g/é¢—</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-3" id="spoonHelpers">
                        <button onclick="setPowder(2)" class="px-3 py-1 bg-stone-100 hover:bg-stone-200 text-stone-600 rounded-full text-xs transition">ğŸ¥„ 1 å¹³å‹º (çº¦2g)</button>
                        <button onclick="setPowder(4)" class="px-3 py-1 bg-stone-100 hover:bg-stone-200 text-stone-600 rounded-full text-xs transition">ğŸ¥„ 2 å¹³å‹º (çº¦4g)</button>
                        <button onclick="setPowder(1.8)" class="px-3 py-1 bg-amber-50 hover:bg-amber-100 text-amber-800 border border-amber-200 rounded-full text-xs transition">â˜• 1æ¡é€Ÿæº¶ (1.8g)</button>
                        <button onclick="setPowder(10)" class="px-3 py-1 bg-stone-100 hover:bg-stone-200 text-stone-600 rounded-full text-xs transition">ğŸ«˜ 10g ç°ç£¨ç²‰</button>
                    </div>
                    <div class="bg-amber-50 text-amber-900 px-4 py-2 rounded-lg text-sm mb-4 flex justify-between items-center border border-amber-100">
                        <span>é¢„ä¼°å«é‡ï¼š</span>
                        <span class="font-bold text-lg"><span id="estimatedMgPowder">0</span> <span class="text-xs font-normal">mg</span></span>
                    </div>
                </div>

                <button onclick="addDrink()" class="w-full bg-[#6F4E37] hover:bg-[#5a3e2b] text-white font-bold py-3 rounded-xl shadow-md transform active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    æ‰‹åŠ¨åŠ å…¥åˆ—è¡¨
                </button>
            </div>

            <!-- åˆ—è¡¨ -->
            <div id="drinkListSection" class="hidden">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-stone-700">é¥®ç”¨æ¸…å•</h3>
                    <button onclick="clearAll()" class="text-xs text-red-400 hover:text-red-600">æ¸…ç©º</button>
                </div>
                <div id="drinkList" class="space-y-2 max-h-40 overflow-y-auto no-scrollbar bg-stone-50 p-2 rounded-lg border border-stone-100"></div>
            </div>

            <!-- ç»“æœé¢æ¿ -->
            <div id="resultPanel" class="hidden border-t-2 border-[#6F4E37] pt-6 relative">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center mb-6">
                    <div class="bg-stone-50 p-4 rounded-xl flex flex-col justify-center items-center relative overflow-hidden shadow-inner">
                        <div id="statusIndicator" class="absolute left-0 top-0 h-full w-2 bg-gray-300"></div>
                        <p class="text-xs text-stone-500 uppercase tracking-wide">æœ‰æ•ˆæ„ŸçŸ¥çŠ¶æ€</p>
                        <p class="text-2xl font-bold mt-1" id="statusText">æœªé¥®ç”¨</p>
                        <div class="text-xs text-stone-400 mt-1 flex gap-2">
                            <span>ç‰©ç†: <b id="phyLevel">0</b>mg</span>
                            <span>â†’</span>
                            <span>æ„ŸçŸ¥: <b id="effLevel" class="text-[#6F4E37]">0</b>mg</span>
                        </div>
                    </div>
                    <div class="bg-stone-50 p-4 rounded-xl border-l-4 border-emerald-400 flex flex-col justify-center items-center">
                        <p class="text-xs text-stone-500 uppercase tracking-wide">ç‰©ç†ç¡çœ é˜ˆå€¼</p>
                        <p class="text-3xl font-bold text-emerald-600 mt-1" id="sleepTime">--:--</p>
                        <p class="text-[10px] text-stone-400">åŸºäºç‰©ç†æ®‹ç•™ < 50mg</p>
                    </div>
                </div>

                <div class="relative h-80 w-full">
                    <canvas id="caffeineChart"></canvas>
                </div>
                
                <div class="flex flex-wrap items-center justify-center gap-3 mt-3 text-[10px] text-stone-400">
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-green-100 border border-green-200"></div> æœ€ä½³æç¥åŒº</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-1 bg-[#6F4E37]"></div> æœ‰æ•ˆæ„ŸçŸ¥æ›²çº¿</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-1 border-t-2 border-dotted border-gray-400"></div> ç‰©ç†æ®‹ç•™</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let drinks = [];
        let currentMode = 'mg'; 
        const STORAGE_KEY = 'caffeine_tracker_v4';
        const today = new Date();
        today.setHours(0,0,0,0);

        // åˆå§‹åŒ–æ—¶é—´
        const now = new Date();
        document.getElementById('drinkTime').value = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        
        document.getElementById('halfLife').addEventListener('input', (e) => {
            document.getElementById('halfLifeDisplay').textContent = e.target.value + 'h';
            saveData();
            if(drinks.length > 0) updateAnalysis();
        });

        // å¯åŠ¨åŠ è½½
        loadData();

        // ----------------- æ ¸å¿ƒç®—æ³•ï¼šProcess S + å›æº¯å¡«è¡¥ä¼˜åŒ– -----------------

        function getProcessSEfficiency(targetTime) {
            const wakeUpStr = document.getElementById('wakeUpTime').value;
            const [wH, wM] = wakeUpStr.split(':').map(Number);
            let wakeTime = new Date(targetTime);
            wakeTime.setHours(wH, wM, 0, 0);
            if (targetTime < wakeTime) wakeTime.setDate(wakeTime.getDate() - 1);
            
            const t_awake = (targetTime - wakeTime) / (1000 * 60 * 60);
            if(t_awake < 0) return 1.0; 

            const tau_w = 18.2; 
            const S = 1 - Math.exp(-t_awake / tau_w);
            const MAX_FATIGUE_PENALTY = 0.6; 
            const efficiency = 1.0 - (S * MAX_FATIGUE_PENALTY);
            return Math.max(0.1, efficiency); 
        }
        
        // è¾…åŠ©ï¼šå•çº¯è·å–ç‰©ç†æ®‹ç•™ (ç”¨äºç¡çœ åˆ¤æ–­)
        function calculatePhysicalLevel(targetTime, drinksList, halfLife) {
            let total = 0;
            drinksList.forEach(d => {
                const h = (targetTime - d.time) / (1000 * 60 * 60);
                if (h >= 0) {
                    total += d.amount * Math.pow(0.5, h / halfLife);
                }
            });
            return total;
        }
        
        // è¾…åŠ©ï¼šè®¡ç®—å•æ¯çš„æ®‹ç•™
        function calculateSingleDrinkResidue(drinkTime, amount, targetTime, halfLife) {
            const h = (targetTime - drinkTime) / (1000 * 60 * 60);
            if (h < 0) return 0;
            return amount * Math.pow(0.5, h / halfLife);
        }

        // --- æ ¸å¿ƒæ›´æ–°ï¼šæ ‡å‡†æ¯+æ™ºèƒ½å›å¡« ç®—æ³• ---
        function executeSmartPlan() {
            // æ¸…é™¤ä¹‹å‰çš„è‡ªåŠ¨è®°å½•ï¼Œé‡æ–°è§„åˆ’
            drinks = drinks.filter(d => !d.isAuto);

            const minFocus = parseFloat(document.getElementById('minFocus').value) || 80;
            const unitDose = parseInt(document.getElementById('smartDoseDisplay').textContent) || 83; // 1æ¯
            
            const sleepTimeStr = document.getElementById('smartSleepTime').value || "23:00";
            const focusTimeStr = document.getElementById('smartFocusEndTime').value || "18:00";
            const halfLife = parseFloat(document.getElementById('halfLife').value);

            // 1. ç¡®å®šæ—¶é—´è¾¹ç•Œ
            const lastExistingDrink = drinks.length > 0 ? drinks[drinks.length - 1] : {time: new Date()};
            let startSimTime = new Date(lastExistingDrink.time);
            if(drinks.length === 0) startSimTime = new Date(); 

            let sleepDate = getTimeToday(sleepTimeStr);
            if (sleepDate < startSimTime) sleepDate.setDate(sleepDate.getDate() + 1);

            let focusEndDate = getTimeToday(focusTimeStr);
            if (focusEndDate < startSimTime && focusEndDate.getHours() < startSimTime.getHours()) {
                focusEndDate.setDate(focusEndDate.getDate() + 1);
            }

            let simTime = new Date(startSimTime);
            const SLEEP_THRESHOLD = 50; 
            let addedCount = 0;
            let backfillCount = 0;

            // 2. æ¨¡æ‹Ÿæ­¥è¿›
            while (simTime < focusEndDate) {
                // è®¡ç®—å½“å‰çš„æœ‰æ•ˆæ„ŸçŸ¥æ°´å¹³
                let physicalLevel = calculatePhysicalLevel(simTime, drinks, halfLife);
                let efficiency = getProcessSEfficiency(simTime);
                let effectiveLevel = physicalLevel * efficiency;

                // å¦‚æœæ„ŸçŸ¥æ°´å¹³ä½äºæœ€ä½è¦æ±‚ï¼Œéœ€è¦è¡¥ç»™
                if (effectiveLevel < minFocus) {
                    
                    // --- ç­–ç•¥ A: å°è¯•å– 1 æ¯ (æ ‡å‡†å•ä½) ---
                    // æ£€æŸ¥è¿™æ¯åœ¨ç¡å‰æ˜¯å¦ä¼šè¶…æ ‡
                    let currentSleepResidue = calculatePhysicalLevel(sleepDate, drinks, halfLife);
                    let newDrinkResidue = calculateSingleDrinkResidue(simTime, unitDose, sleepDate, halfLife);
                    
                    if (currentSleepResidue + newDrinkResidue <= SLEEP_THRESHOLD) {
                        // å¯ä»¥å–ï¼
                        addAutoDrink(simTime, unitDose, 1.0);
                        simTime.setMinutes(simTime.getMinutes() + 45); // å–å®Œç®¡ä¸€é˜µ
                        continue;
                    } else {
                        // --- ç­–ç•¥ B: æ­¤æ—¶ä¸èƒ½å–ï¼Œå°è¯•å›å¡« (Boost Previous) ---
                        // æˆ‘ä»¬éœ€è¦æå‡ç°åœ¨çš„æ°´å¹³ï¼Œä½†ç°åœ¨å–å¤ªæ™šäº†ã€‚
                        // å°è¯•æŠŠä¹‹å‰çš„æŸä¸€æ¯åŠ é‡ 0.5 å€ã€‚
                        // å¯»æ‰¾æœ€è¿‘çš„ä¸€æ¯å¯æ“ä½œçš„å’–å•¡ (isAuto æˆ– æ‰‹åŠ¨çš†å¯ï¼Œè¿™é‡Œæˆ‘ä»¬åªæ”¹ drinks é‡Œçš„å¯¹è±¡)
                        // å€’åºæŸ¥æ‰¾
                        
                        let boostedSuccess = false;
                        
                        for (let i = drinks.length - 1; i >= 0; i--) {
                            let d = drinks[i];
                            // é™åˆ¶ï¼šä¸è¦åŠ å¾—å¤ªç¦»è°±ï¼Œæ¯”å¦‚æœ€å¤šåŠ åˆ° 2.5 å€
                            let currentMult = d.multiplier || 1.0;
                            if (currentMult >= 2.5) continue; 
                            
                            let boostAmount = Math.round(unitDose * 0.5); // åŠ åŠæ¯
                            let boostResidue = calculateSingleDrinkResidue(d.time, boostAmount, sleepDate, halfLife);
                            
                            // æ£€æŸ¥åŠ é‡åçš„æ€»ç¡çœ æ®‹ç•™
                            // æ³¨æ„ï¼šcurrentSleepResidue å·²ç»åŒ…å«äº† d çš„åŸå§‹æ®‹ç•™ï¼Œæ‰€ä»¥ç›´æ¥åŠ  boostResidue å³å¯
                            if (currentSleepResidue + boostResidue <= SLEEP_THRESHOLD) {
                                // æˆåŠŸï¼æ‰§è¡Œå›å¡«
                                d.amount += boostAmount;
                                d.multiplier = currentMult + 0.5;
                                d.isBoosted = true; // æ ‡è®°ç”¨äºUIé«˜äº®
                                boostedSuccess = true;
                                backfillCount++;
                                break; // æ‰¾åˆ°ä¸€ä¸ªå°±å¤Ÿäº†ï¼Œè·³å‡ºå¾ªç¯
                            }
                        }
                        
                        if (boostedSuccess) {
                            // å›å¡«æˆåŠŸåï¼Œæ›²çº¿æŠ¬é«˜äº†ã€‚
                            // æˆ‘ä»¬ä¸ç§»åŠ¨ simTimeï¼Œè€Œæ˜¯ç›´æ¥è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯é‡æ–°æ£€æµ‹ effectiveLevelã€‚
                            // å¦‚æœæŠ¬é«˜åè¿˜ä¸å¤Ÿï¼Œä¸‹æ¬¡å¾ªç¯ä¼šå†æ¬¡è§¦å‘ (å¯èƒ½å†å–ä¸€æ¯ï¼Œæˆ–å†å›å¡«)
                            continue;
                        } else {
                            // å›å¡«ä¹Ÿæ•‘ä¸äº† (æˆ–è€…æ²¡å¾—å›å¡«)ï¼Œä¹Ÿæ²¡æ³•å–æ–°çš„ã€‚
                            // å½»åº•èººå¹³ï¼Œåœæ­¢è§„åˆ’ã€‚
                            break;
                        }
                    }
                }
                simTime.setMinutes(simTime.getMinutes() + 15);
            }
            
            function addAutoDrink(time, amount, multiplier) {
                const newDrink = {
                    id: Date.now() + Math.random(),
                    time: new Date(time),
                    timeStr: time.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                    amount: amount,
                    isAuto: true,
                    multiplier: multiplier // è®°å½•å€æ•°ç”¨äºæ˜¾ç¤º
                };
                drinks.push(newDrink);
                addedCount++;
            }

            drinks.sort((a, b) => a.time - b.time);
            saveData();
            renderList();
            updateAnalysis();
            document.getElementById('resultPanel').scrollIntoView({ behavior: 'smooth' });
            
            if (addedCount > 0 || backfillCount > 0) {
                let msg = `è§„åˆ’å®Œæˆ: æ–°å¢ ${addedCount} æ¯`;
                if(backfillCount > 0) msg += `, åŠ æµ“ ${backfillCount} æ¬¡`;
                showToast(msg);
            } else {
                showToast("æ— éœ€è¡¥ç»™ï¼Œæˆ–å—ç¡çœ é™åˆ¶æ— æ³•æ·»åŠ ");
            }
        }

        let caffeineChart = null;

        function updateAnalysis() {
            if (drinks.length === 0) return;
            document.getElementById('resultPanel').classList.remove('hidden');

            const halfLife = parseFloat(document.getElementById('halfLife').value);
            const minFocus = parseFloat(document.getElementById('minFocus').value);
            const maxFocus = parseFloat(document.getElementById('maxFocus').value);
            const nowTime = new Date();

            const wakeUpStr = document.getElementById('wakeUpTime').value;
            const [wH, wM] = wakeUpStr.split(':').map(Number);
            let wDate = new Date(); wDate.setHours(wH, wM, 0, 0);
            if(nowTime < wDate) wDate.setDate(wDate.getDate()-1); 
            
            const hoursAwake = Math.max(0, (nowTime - wDate) / (1000*60*60));
            const efficiency = getProcessSEfficiency(nowTime);
            
            document.getElementById('hoursAwakeDisplay').innerText = hoursAwake.toFixed(1);
            document.getElementById('efficiencyDisplay').innerText = Math.round(efficiency * 100) + "%";
            document.getElementById('fatigueLevelDisplay').innerText = Math.round((1-efficiency)*100) + "%"; // ç®€å•å±•ç¤ºç–²åŠ³åº¦

            const phyLevel = calculatePhysicalLevel(nowTime, drinks, halfLife);
            const effLevel = phyLevel * efficiency;

            document.getElementById('phyLevel').innerText = phyLevel.toFixed(0);
            document.getElementById('effLevel').innerText = effLevel.toFixed(0);

            const statusBox = document.getElementById('statusText');
            const indicator = document.getElementById('statusIndicator');
            
            if (effLevel > maxFocus) {
                statusBox.innerText = "âš ï¸ æµ“åº¦è¿‡é«˜";
                statusBox.className = "text-2xl font-bold mt-1 text-red-600";
                indicator.className = "absolute left-0 top-0 h-full w-2 bg-red-500";
            } else if (effLevel >= minFocus) {
                statusBox.innerText = "ğŸ§  é«˜æ•ˆæç¥ä¸­";
                statusBox.className = "text-2xl font-bold mt-1 text-green-700";
                indicator.className = "absolute left-0 top-0 h-full w-2 bg-green-500";
            } else {
                statusBox.innerText = "ğŸ“‰ æµ“åº¦è¾ƒä½";
                statusBox.className = "text-2xl font-bold mt-1 text-stone-500";
                indicator.className = "absolute left-0 top-0 h-full w-2 bg-stone-300";
            }

            let checkTime = new Date(nowTime);
            let safeTimeText = "> 48h";
            for(let i=0; i<288; i++) {
                const p = calculatePhysicalLevel(checkTime, drinks, halfLife);
                if(p < 50) {
                    const isTomorrow = checkTime.getDate() !== today.getDate();
                    const tStr = checkTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    safeTimeText = isTomorrow ? `æ¬¡æ—¥ ${tStr}` : tStr;
                    break;
                }
                checkTime.setMinutes(checkTime.getMinutes() + 10);
            }
            document.getElementById('sleepTime').innerText = safeTimeText;

            updateChart(halfLife, minFocus, maxFocus);
        }

        function updateChart(halfLife, minFocus, maxFocus) {
            const ctx = document.getElementById('caffeineChart').getContext('2d');
            
            let startTime = drinks.length > 0 ? new Date(drinks[0].time) : new Date();
            startTime.setHours(startTime.getHours() - 1);
            
            const labels = [];
            const phyData = [];
            const effData = []; 
            const zoneTop = [];
            const zoneBottom = [];
            
            for (let i = 0; i <= 24; i++) { 
                const t = new Date(startTime.getTime() + i * 60 * 60 * 1000);
                labels.push(t.getHours() + ":00");
                
                const p = calculatePhysicalLevel(t, drinks, halfLife);
                const e = p * getProcessSEfficiency(t);
                
                phyData.push(p);
                effData.push(e);
                zoneTop.push(maxFocus);
                zoneBottom.push(minFocus);
            }

            if (caffeineChart) { caffeineChart.destroy(); caffeineChart = null; }

            caffeineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æœ‰æ•ˆæ„ŸçŸ¥ (ç–²åŠ³ä¿®æ­£)',
                            data: effData,
                            borderColor: '#6F4E37',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 0,
                            order: 1
                        },
                        {
                            label: 'ç‰©ç†æ®‹ç•™ (Body)',
                            data: phyData,
                            borderColor: '#9CA3AF', 
                            borderWidth: 2,
                            borderDash: [3, 3],
                            pointRadius: 0,
                            tension: 0.4,
                            order: 2
                        },
                        {
                            label: 'æç¥åŒº',
                            data: zoneBottom,
                            borderColor: 'rgba(34, 197, 94, 0.5)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: '-1', 
                            borderWidth: 1,
                            pointRadius: 0,
                            order: 4
                        },
                         {
                            label: 'ä¸Šé™',
                            data: zoneTop,
                            borderColor: 'rgba(239, 68, 68, 0.2)',
                            fill: '-1', 
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 1,
                            pointRadius: 0,
                            order: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f5f5f4' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // --- åŸºç¡€åŠŸèƒ½å‡½æ•° ---

        function getTimeToday(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            const d = new Date(today);
            d.setHours(h, m, 0, 0);
            return d;
        }

        function syncSliders(source) {
            const minSlider = document.getElementById('minFocusSlider');
            const maxSlider = document.getElementById('maxFocusSlider');
            let minVal = parseInt(minSlider.value);
            let maxVal = parseInt(maxSlider.value);

            if (minVal > maxVal) {
                if (source === 'min') { maxSlider.value = minVal; maxVal = minVal; } 
                else { minSlider.value = maxVal; minVal = maxVal; }
            }

            document.getElementById('minFocus').value = minVal;
            document.getElementById('maxFocus').value = maxVal;
            document.getElementById('lblMinInput').innerText = minVal;
            document.getElementById('lblMaxInput').innerText = maxVal;

            const visualScale = 500;
            const leftPct = (minVal / visualScale) * 100;
            const widthPct = ((maxVal - minVal) / visualScale) * 100;
            const bar = document.getElementById('visualZoneBar');
            bar.style.left = leftPct + '%';
            bar.style.width = widthPct + '%';
            
            saveData();
            if(drinks.length > 0) updateAnalysis();
        }

        function calcSmartDose() {
            const ratio = parseFloat(document.getElementById('smartDrinkType').value);
            const volume = parseFloat(document.getElementById('smartDrinkVolume').value) || 0;
            document.getElementById('smartDoseDisplay').textContent = Math.round(volume * ratio);
        }

        // --- Tab åˆ‡æ¢é€»è¾‘ (æ¢å¤) ---
        function switchTab(mode) {
            currentMode = mode;
            ['mg', 'ml', 'powder'].forEach(m => {
                const tab = document.getElementById('tab' + m.charAt(0).toUpperCase() + m.slice(1));
                const panel = document.getElementById('mode' + m.charAt(0).toUpperCase() + m.slice(1));
                
                if (m === mode) {
                    tab.classList.add('tab-active');
                    tab.classList.remove('tab-inactive');
                    panel.classList.remove('hidden');
                } else {
                    tab.classList.add('tab-inactive');
                    tab.classList.remove('tab-active');
                    panel.classList.add('hidden');
                }
            });
        }

        // --- å®æ—¶è®¡ç®—é¢„è§ˆ (æ¢å¤) ---
        function calcFromVolume() {
            const ratio = parseFloat(document.getElementById('drinkTypeMl').value);
            const volume = parseFloat(document.getElementById('volumeInput').value) || 0;
            const estimated = Math.round(volume * ratio);
            document.getElementById('estimatedMgMl').textContent = estimated;
        }

        function calcFromPowder() {
            const ratio = parseFloat(document.getElementById('powderType').value);
            const amount = parseFloat(document.getElementById('powderInput').value) || 0;
            const estimated = Math.round(amount * ratio);
            document.getElementById('estimatedMgPowder').textContent = estimated;
        }

        function setAmount(val) { 
            document.getElementById('caffeineAmount').value = val;
            const el = document.getElementById('caffeineAmount');
            el.classList.add('ring-2', 'ring-[#6F4E37]');
            setTimeout(() => el.classList.remove('ring-2', 'ring-[#6F4E37]'), 200);
        }

        function setPowder(val) {
            const input = document.getElementById('powderInput');
            input.value = val;
            calcFromPowder();
            input.classList.add('ring-2', 'ring-[#6F4E37]');
            setTimeout(() => input.classList.remove('ring-2', 'ring-[#6F4E37]'), 200);
        }

        // --- æ·»åŠ è®°å½• (å¤šæ¨¡å¼æ•´åˆ) ---
        function addDrink() {
            const timeStr = document.getElementById('drinkTime').value;
            let amount = 0;

            if (currentMode === 'mg') {
                amount = parseFloat(document.getElementById('caffeineAmount').value);
            } else if (currentMode === 'ml') {
                const ratio = parseFloat(document.getElementById('drinkTypeMl').value);
                const volume = parseFloat(document.getElementById('volumeInput').value);
                if (isNaN(volume) || volume <= 0) { showToast("è¯·è¾“å…¥æœ‰æ•ˆå®¹é‡", true); return; }
                amount = Math.round(volume * ratio);
            } else if (currentMode === 'powder') {
                const ratio = parseFloat(document.getElementById('powderType').value);
                const weight = parseFloat(document.getElementById('powderInput').value);
                if (isNaN(weight) || weight <= 0) { showToast("è¯·è¾“å…¥æœ‰æ•ˆç²‰é‡", true); return; }
                amount = Math.round(weight * ratio);
            }
            
            if (!timeStr || isNaN(amount) || amount <= 0) { showToast("è¯·è¾“å…¥æœ‰æ•ˆæ•°å€¼", true); return; }

            const d = getTimeToday(timeStr);
            drinks.push({ id: Date.now(), time: d, timeStr: timeStr, amount: amount, isAuto: false });
            drinks.sort((a,b) => a.time - b.time);
            
            saveData(); renderList(); updateAnalysis(); showToast("æ·»åŠ æˆåŠŸ");
            
            // æ¸…ç©ºå¯¹åº”è¾“å…¥æ¡†
            if (currentMode === 'mg') document.getElementById('caffeineAmount').value = '';
            if (currentMode === 'ml') document.getElementById('volumeInput').value = '';
            if (currentMode === 'powder') document.getElementById('powderInput').value = '';
        }

        function removeDrink(id) {
            drinks = drinks.filter(d => d.id !== id);
            saveData(); renderList(); 
            if(drinks.length === 0) { 
                document.getElementById('resultPanel').classList.add('hidden'); 
                if(caffeineChart) { caffeineChart.destroy(); caffeineChart = null; }
            }
            else updateAnalysis();
        }

        function clearAll() {
            drinks = []; saveData(); renderList();
            document.getElementById('resultPanel').classList.add('hidden');
            if(caffeineChart) { caffeineChart.destroy(); caffeineChart = null; }
            showToast("å·²æ¸…ç©º");
        }

        function renderList() {
            const list = document.getElementById('drinkList');
            const section = document.getElementById('drinkListSection');
            if(drinks.length===0) { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');
            
            list.innerHTML = drinks.map(d => `
                <div class="flex justify-between items-center bg-white p-3 rounded shadow-sm border border-stone-100 animate-slide-in ${d.isAuto ? 'border-l-4 border-indigo-400 bg-indigo-50' : ''}">
                    <div class="flex items-center gap-3">
                        <div class="${d.isAuto ? 'bg-indigo-500' : 'bg-[#6F4E37]'} text-white text-xs px-2 py-1 rounded flex items-center gap-1">
                            ${d.timeStr} 
                            ${d.isAuto ? '<span class="text-[9px] opacity-80 ml-1">è‡ªåŠ¨</span>' : ''}
                            ${d.isBoosted ? '<span class="text-[9px] bg-red-100 text-red-600 px-1 rounded-sm ml-1 font-bold">åŠ æµ“</span>' : ''}
                        </div>
                        <span class="font-medium text-stone-700">${d.amount} mg ${d.multiplier && d.multiplier > 1 ? '<span class="text-xs text-stone-400">('+d.multiplier+'å€)</span>' : ''}</span>
                    </div>
                    <button onclick="removeDrink(${d.id})" class="text-stone-400 hover:text-red-500 p-1">Ã—</button>
                </div>
            `).join('');
        }

        function tryGenerateSmartPlan() { showConfirm(executeSmartPlan); }
        function showToast(msg, err=false) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            document.getElementById('toastIcon').innerText = err ? 'âš ï¸' : 'âœ…';
            t.classList.remove('hidden', 'toast-exit'); t.classList.add('toast-enter-active');
            setTimeout(() => { t.classList.add('toast-exit'); setTimeout(()=>t.classList.add('hidden'),300); }, 2000);
        }
        let onConfirm = null;
        function showConfirm(cb) { onConfirm = cb; document.getElementById('confirmModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('confirmModal').classList.add('hidden'); onConfirm = null; }
        document.getElementById('confirmActionBtn').onclick = () => { if(onConfirm) onConfirm(); closeModal(); };

        function saveData() {
            const data = {
                drinks, 
                halfLife: document.getElementById('halfLife').value,
                minFocus: document.getElementById('minFocus').value,
                maxFocus: document.getElementById('maxFocus').value,
                wakeUpTime: document.getElementById('wakeUpTime').value,
                smartDrinkVolume: document.getElementById('smartDrinkVolume').value,
                smartFocusEndTime: document.getElementById('smartFocusEndTime').value,
                smartSleepTime: document.getElementById('smartSleepTime').value
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadData() {
            const d = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if(d) {
                if(d.drinks) drinks = d.drinks.map(x => ({...x, time: new Date(x.time)}));
                if(d.halfLife) { document.getElementById('halfLife').value = d.halfLife; document.getElementById('halfLifeDisplay').innerText = d.halfLife+'h'; }
                if(d.minFocus) { document.getElementById('minFocusSlider').value = d.minFocus; syncSliders('init'); }
                if(d.maxFocus) document.getElementById('maxFocusSlider').value = d.maxFocus;
                if(d.wakeUpTime) document.getElementById('wakeUpTime').value = d.wakeUpTime;
                if(d.smartDrinkVolume) document.getElementById('smartDrinkVolume').value = d.smartDrinkVolume;
                if(d.smartFocusEndTime) document.getElementById('smartFocusEndTime').value = d.smartFocusEndTime;
                if(d.smartSleepTime) document.getElementById('smartSleepTime').value = d.smartSleepTime;
                
                syncSliders('init');
                calcSmartDose();
                if(drinks.length > 0) { renderList(); updateAnalysis(); }
            } else { syncSliders('init'); }
        }
    </script>
</body>
</html>
