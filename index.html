<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å’–å•¡å› ä»£è°¢è®¡ç®—å™¨ (æ™ºèƒ½è§„åˆ’ç‰ˆ)</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* åˆ—è¡¨è¿›å…¥åŠ¨ç”» */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }
        /* Tab æ¿€æ´»æ ·å¼ */
        .tab-active {
            background-color: #F5F5F4; /* stone-100 */
            border-bottom: 2px solid #6F4E37;
            color: #6F4E37;
            font-weight: bold;
        }
        .tab-inactive {
            color: #A8A29E; /* stone-400 */
        }
        .tab-inactive:hover {
            color: #57534E; /* stone-600 */
        }
        /* è‡ªå®šä¹‰æ»‘å—æ ·å¼ */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #6F4E37;
            cursor: pointer;
            margin-top: -6px; 
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #E7E5E4; /* stone-200 */
            border-radius: 2px;
        }
        /* ç®€å•çš„ Toast åŠ¨ç”» */
        .toast-enter { opacity: 0; transform: translate(-50%, -20px); }
        .toast-enter-active { opacity: 1; transform: translate(-50%, 0); transition: all 0.3s ease-out; }
        .toast-exit { opacity: 1; transform: translate(-50%, 0); }
        .toast-exit-active { opacity: 0; transform: translate(-50%, -20px); transition: all 0.3s ease-in; }
    </style>
</head>
<body class="bg-stone-100 text-stone-800 min-h-screen flex items-center justify-center p-4">

    <!-- å…¨å±€æç¤ºæ¡† (Toast) -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-stone-800 text-white px-6 py-3 rounded-full shadow-xl z-50 hidden flex items-center gap-2">
        <span id="toastIcon">âš ï¸</span>
        <span id="toastMsg">æç¤ºä¿¡æ¯</span>
    </div>

    <!-- ç¡®è®¤æ¨¡æ€æ¡† (Modal) -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-100">
            <h3 class="text-lg font-bold text-stone-800 mb-2">ç¡®è®¤ç”Ÿæˆè®¡åˆ’ï¼Ÿ</h3>
            <p class="text-sm text-stone-500 mb-6">ç³»ç»Ÿå°†åŸºäºæ‚¨å·²æ·»åŠ çš„ç¬¬ä¸€æ¯å’–å•¡ï¼Œè‡ªåŠ¨è®¡ç®—åç»­è¡¥ç»™æ—¶é—´ã€‚ä¸ºäº†åœ¨ä¿è¯ç¡çœ çš„å‰æä¸‹ç»´æŒæç¥ï¼Œç³»ç»Ÿå¯èƒ½ä¼šå»ºè®®<b>å‡åŠå‰‚é‡</b>ã€‚</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-stone-500 hover:bg-stone-100 rounded-lg transition-colors font-medium text-sm">å–æ¶ˆ</button>
                <button id="confirmActionBtn" class="px-4 py-2 bg-[#6F4E37] text-white rounded-lg hover:bg-[#5a3e2b] transition-colors font-medium text-sm shadow-md">ç¡®å®šç”Ÿæˆ</button>
            </div>
        </div>
    </div>

    <div class="max-w-2xl w-full bg-white rounded-2xl shadow-xl overflow-hidden border border-stone-200">
        
        <!-- å¤´éƒ¨ -->
        <div class="bg-[#6F4E37] p-6 text-white text-center relative">
            <h1 class="text-2xl font-bold tracking-wider">â˜• å’–å•¡å› ç»´æŒæ›²çº¿</h1>
            <p class="text-[#D2B48C] text-sm mt-1">è®¡ç®—æœ€ä½³æç¥çª—å£ & å®‰å¿ƒç¡çœ æ—¶é—´</p>
        </div>

        <div class="p-6 space-y-6">
            
            <!-- å…¨å±€è®¾ç½®åŒºåŸŸ -->
            <div class="bg-stone-50 p-4 rounded-xl border border-stone-100 space-y-5">
                <!-- åŠè¡°æœŸ -->
                <div>
                    <label class="block text-sm font-medium text-stone-500 mb-1 flex justify-between">
                        <span>ä½ çš„ä»£è°¢åŠè¡°æœŸ</span>
                        <span id="halfLifeDisplay" class="text-[#6F4E37] font-bold">5.0h</span>
                    </label>
                    <input type="range" id="halfLife" min="3" max="10" step="0.5" value="5" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-[#6F4E37]">
                </div>

                <!-- æç¥åŒºé—´è®¾ç½® -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-bold text-stone-500 uppercase tracking-wide">ğŸ§  æœ€ä½³æç¥åŒºé—´ (ç›®æ ‡æµ“åº¦)</span>
                    </div>
                    
                    <!-- åŠ¨æ€è§†è§‰æ¡ -->
                    <div class="relative h-4 w-full bg-stone-200 rounded-full mb-4 overflow-hidden">
                        <div id="visualZoneBar" class="absolute top-0 h-full bg-green-300 opacity-60 transition-all duration-300" style="left: 16%; width: 34%;"></div>
                        <div class="absolute top-0 h-full w-px bg-white/50 left-[20%]"></div>
                        <div class="absolute top-0 h-full w-px bg-white/50 left-[40%]"></div>
                        <div class="absolute top-0 h-full w-px bg-white/50 left-[60%]"></div>
                        <div class="absolute top-0 h-full w-px bg-white/50 left-[80%]"></div>
                    </div>

                    <!-- ä¸¤ä¸ªæ§åˆ¶æ»‘å— -->
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="flex justify-between text-xs text-stone-500 mb-1">
                                <span>æœ€ä½æœ‰æ•ˆ (è¡¥ç»™çº¿)</span>
                                <span class="font-bold text-[#6F4E37]"><span id="lblMinInput">80</span>mg</span>
                            </label>
                            <input type="range" id="minFocusSlider" min="0" max="400" step="10" value="80" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer" oninput="syncSliders('min')">
                        </div>
                        <div>
                            <label class="flex justify-between text-xs text-stone-500 mb-1">
                                <span>ç„¦è™‘è­¦æˆ’ (ä¸Šé™)</span>
                                <span class="font-bold text-red-500"><span id="lblMaxInput">250</span>mg</span>
                            </label>
                            <input type="range" id="maxFocusSlider" min="0" max="500" step="10" value="250" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer" oninput="syncSliders('max')">
                        </div>
                    </div>
                    
                    <input type="hidden" id="minFocus" value="80">
                    <input type="hidden" id="maxFocus" value="250">
                </div>
            </div>

            <!-- æ™ºèƒ½è¡¥å’–åŠ©æ‰‹ -->
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 shadow-sm relative overflow-hidden">
                <div class="absolute top-0 right-0 p-2 opacity-10 text-indigo-900 pointer-events-none text-6xl">âš¡</div>
                <div class="flex items-center gap-2 mb-3 relative z-10">
                    <span class="text-lg">ğŸ¤–</span>
                    <h3 class="text-sm font-bold text-indigo-900">æ™ºèƒ½è¡¥å’–è§„åˆ’</h3>
                </div>
                
                <p class="text-xs text-indigo-600 mb-3 leading-relaxed">
                    æ“ä½œæ­¥éª¤ï¼š<br>
                    1. è¯·å…ˆåœ¨ä¸‹æ–¹<b>æ‰‹åŠ¨æ·»åŠ ç¬¬ä¸€æ¯</b>ï¼ˆå¦‚ 08:00 æ—©é¤å’–å•¡ï¼‰ã€‚<br>
                    2. è®¾å®š<b>å·¥ä½œç»“æŸ(ç»´æŒç›´åˆ°)</b>æ—¶é—´åŠ<b>å…¥ç¡</b>æ—¶é—´ã€‚<br>
                    3. ç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®—ã€‚è‹¥å…¨é‡è¡¥ç»™å½±å“ç¡çœ ï¼Œç³»ç»Ÿå°†å°è¯•<b>è‡ªåŠ¨å‡é‡</b>ã€‚
                </p>

                <!-- æ¯æ¬¡è¡¥ç»™è®¾ç½®åŒº -->
                <div class="bg-white/60 p-3 rounded-lg border border-indigo-100 mb-3 relative z-10">
                    <label class="text-xs text-indigo-500 block mb-1 font-medium flex justify-between">
                        <span>æ¯æ¬¡è¡¥ç»™è®¾å®š (åŸºå‡†)</span>
                        <span class="text-indigo-400 font-normal">å•æ¬¡æ‘„å…¥ â‰ˆ <span id="smartDoseDisplay" class="font-bold text-indigo-700">83</span> mg</span>
                    </label>
                    <div class="flex gap-2">
                        <select id="smartDrinkType" onchange="calcSmartDose();saveData();" class="flex-grow p-2 bg-white border border-indigo-200 rounded text-sm text-indigo-900 focus:ring-2 focus:ring-indigo-300 outline-none">
                            <option value="0.55">â˜• ç¾å¼ (é»‘å’–)</option>
                            <option value="0.40">ğŸ¥› æ‹¿é“ (å¥¶å’–)</option>
                            <option value="2.10">â˜• æµ“ç¼© (Espresso)</option>
                            <option value="1.00">ğŸ§Š å†·èƒå’–å•¡</option>
                            <option value="0.32">âš¡ èƒ½é‡é¥®æ–™</option>
                            <option value="0.35">ğŸµ èŒ¶ç±»</option>
                        </select>
                        <div class="relative w-24 flex-shrink-0">
                            <input type="number" id="smartDrinkVolume" value="150" oninput="calcSmartDose();saveData();" class="w-full p-2 pr-6 bg-white border border-indigo-200 rounded text-sm text-indigo-900 text-center focus:ring-2 focus:ring-indigo-300 outline-none">
                            <span class="absolute right-2 top-2 text-xs text-indigo-300 pointer-events-none">ml</span>
                        </div>
                    </div>
                </div>

                <!-- æ—¶é—´è®¾ç½®åŒº -->
                <div class="grid grid-cols-2 gap-3 mb-3 relative z-10">
                    <div>
                        <label class="text-xs text-indigo-500 block mb-1 font-medium">ç»´æŒæç¥ç›´åˆ°</label>
                        <input type="time" id="smartFocusEndTime" onchange="saveData()" value="18:00" class="w-full p-2 bg-white border border-indigo-200 rounded text-sm text-indigo-900 text-center focus:ring-2 focus:ring-indigo-300 outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-indigo-500 block mb-1 font-medium">é¢„è®¡å…¥ç¡æ—¶é—´</label>
                        <input type="time" id="smartSleepTime" onchange="saveData()" value="23:00" class="w-full p-2 bg-white border border-indigo-200 rounded text-sm text-indigo-900 text-center focus:ring-2 focus:ring-indigo-300 outline-none">
                    </div>
                </div>

                <button onclick="tryGenerateSmartPlan()" class="relative z-10 w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2.5 rounded-lg transition-all shadow-md active:scale-95 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    ç”Ÿæˆä¸å½±å“ç¡çœ çš„è¡¥ç»™è¡¨
                </button>
            </div>

            <!-- æ·»åŠ åŒºåŸŸ -->
            <div class="border-t border-stone-100 pt-4" id="manualAddSection">
                <h3 class="text-sm font-bold text-stone-700 mb-3">æ‰‹åŠ¨è®°å½• (ç¬¬ä¸€æ¯è¯·åœ¨æ­¤æ·»åŠ )</h3>
                
                <div class="mb-4">
                    <label class="text-xs font-medium text-stone-400 mb-1 block">é¥®ç”¨æ—¶é—´</label>
                    <input type="time" id="drinkTime" class="w-full p-3 bg-stone-50 border border-stone-300 rounded-lg focus:ring-2 focus:ring-[#6F4E37] outline-none">
                </div>

                <div class="flex border-b border-stone-200 mb-4">
                    <button id="tabMg" onclick="switchTab('mg')" class="flex-1 py-2 text-xs md:text-sm transition-all tab-active">ç›´æ¥è¾“å…¥</button>
                    <button id="tabMl" onclick="switchTab('ml')" class="flex-1 py-2 text-xs md:text-sm transition-all tab-inactive">æŒ‰æ¶²ä½“é‡</button>
                    <button id="tabPowder" onclick="switchTab('powder')" class="flex-1 py-2 text-xs md:text-sm transition-all tab-inactive">æŒ‰ç²‰/è±†é‡</button>
                </div>

                <div id="modeMg" class="block mode-panel">
                    <div class="relative mb-3">
                        <input type="number" id="caffeineAmount" placeholder="å«é‡ (mg)" class="w-full p-3 pl-4 pr-12 bg-stone-50 border border-stone-300 rounded-lg focus:ring-2 focus:ring-[#6F4E37] outline-none font-semibold">
                        <span class="absolute right-4 top-3.5 text-stone-400 text-sm">mg</span>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="setAmount(40)" class="px-3 py-1 bg-stone-100 hover:bg-stone-200 text-stone-600 rounded-full text-xs transition">ğŸ¥¤ å¯ä¹ 40</button>
                        <button onclick="setAmount(95)" class="px-3 py-1 bg-amber-50 hover:bg-amber-100 text-amber-800 border border-amber-200 rounded-full text-xs transition font-medium">â˜• ç¾å¼ 95</button>
                        <button onclick="setAmount(180)" class="px-3 py-1 bg-stone-100 hover:bg-stone-200 text-stone-600 rounded-full text-xs transition">ğŸ§Š å¤§æ¯å†·èƒ 180</button>
                    </div>
                </div>

                <div id="modeMl" class="hidden mode-panel">
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="text-xs text-stone-400 block mb-1">é¥®å“ç±»å‹</label>
                            <select id="drinkTypeMl" onchange="calcFromVolume()" class="w-full p-3 bg-stone-50 border border-stone-300 rounded-lg focus:ring-2 focus:ring-[#6F4E37] outline-none text-sm">
                                <option value="0.55">â˜• å¸¸è§ç¾å¼/é»‘å’–</option>
                                <option value="0.40">ğŸ¥› æ‹¿é“/å¥¶å’–</option>
                                <option value="2.10">â˜• æµ“ç¼© (Espresso)</option>
                                <option value="1.00">ğŸ§Š å†·èƒå’–å•¡</option>
                                <option value="0.32">âš¡ èƒ½é‡é¥®æ–™</option>
                                <option value="0.20">ğŸµ èŒ¶ç±»</option>
                                <option value="0.10">ğŸ¥¤ å¯ä¹/è½¯é¥®</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-stone-400 block mb-1">æ¶²ä½“å®¹é‡</label>
                            <div class="relative">
                                <input type="number" id="volumeInput" placeholder="ä¾‹å¦‚: 350" oninput="calcFromVolume()" class="w-full p-3 pl-3 pr-10 bg-stone-50 border border-stone-300 rounded-lg focus:ring-2 focus:ring-[#6F4E37] outline-none">
                                <span class="absolute right-3 top-3 text-stone-400 text-sm">ml</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-amber-50 text-amber-900 px-4 py-2 rounded-lg text-sm mb-4 flex justify-between items-center border border-amber-100">
                        <span>é¢„ä¼°å«é‡ï¼š</span>
                        <span class="font-bold text-lg"><span id="estimatedMgMl">0</span> <span class="text-xs font-normal">mg</span></span>
                    </div>
                </div>

                <div id="modePowder" class="hidden mode-panel">
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="text-xs text-stone-400 block mb-1">åŸæ–™ç±»å‹</label>
                            <select id="powderType" onchange="calcFromPowder()" class="w-full p-3 bg-stone-50 border border-stone-300 rounded-lg focus:ring-2 focus:ring-[#6F4E37] outline-none text-sm">
                                <option value="35">ğŸ“¦ é€Ÿæº¶/å†»å¹²ç²‰</option>
                                <option value="10">ğŸ«˜ ç°ç£¨è±†/æ‰‹å†²ç²‰</option>
                                <option value="55">ğŸ’Š èƒ¶å›Š (æ¯é¢—)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-stone-400 block mb-1">ç”¨é‡ (å…‹/é¢—)</label>
                            <div class="relative">
                                <input type="number" id="powderInput" placeholder="ä¾‹å¦‚: 2" oninput="calcFromPowder()" class="w-full p-3 pl-3 pr-10 bg-stone-50 border border-stone-300 rounded-lg focus:ring-2 focus:ring-[#6F4E37] outline-none">
                                <span class="absolute right-3 top-3 text-stone-400 text-sm">g/é¢—</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-3" id="spoonHelpers">
                        <button onclick="setPowder(2)" class="px-3 py-1 bg-stone-100 hover:bg-stone-200 text-stone-600 rounded-full text-xs transition">ğŸ¥„ 1 å¹³å‹º (çº¦2g)</button>
                        <button onclick="setPowder(4)" class="px-3 py-1 bg-stone-100 hover:bg-stone-200 text-stone-600 rounded-full text-xs transition">ğŸ¥„ 2 å¹³å‹º (çº¦4g)</button>
                        <button onclick="setPowder(1.8)" class="px-3 py-1 bg-amber-50 hover:bg-amber-100 text-amber-800 border border-amber-200 rounded-full text-xs transition">â˜• 1æ¡é€Ÿæº¶ (1.8g)</button>
                        <button onclick="setPowder(10)" class="px-3 py-1 bg-stone-100 hover:bg-stone-200 text-stone-600 rounded-full text-xs transition">ğŸ«˜ 10g ç°ç£¨ç²‰</button>
                    </div>
                    <div class="bg-amber-50 text-amber-900 px-4 py-2 rounded-lg text-sm mb-4 flex justify-between items-center border border-amber-100">
                        <span>é¢„ä¼°å«é‡ï¼š</span>
                        <span class="font-bold text-lg"><span id="estimatedMgPowder">0</span> <span class="text-xs font-normal">mg</span></span>
                    </div>
                </div>

                <button onclick="addDrink()" class="w-full bg-[#6F4E37] hover:bg-[#5a3e2b] text-white font-bold py-3 rounded-xl shadow-md transform active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    æ‰‹åŠ¨åŠ å…¥åˆ—è¡¨
                </button>
            </div>

            <!-- é¥®ç”¨åˆ—è¡¨ -->
            <div id="drinkListSection" class="hidden">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-stone-700">ä»Šæ—¥é¥®ç”¨æ¸…å•</h3>
                    <button onclick="clearAll()" class="text-xs text-red-400 hover:text-red-600">æ¸…ç©ºåˆ—è¡¨</button>
                </div>
                <div id="drinkList" class="space-y-2 max-h-40 overflow-y-auto no-scrollbar bg-stone-50 p-2 rounded-lg border border-stone-100"></div>
            </div>

            <!-- ç»“æœé¢æ¿ -->
            <div id="resultPanel" class="hidden border-t-2 border-[#6F4E37] pt-6 relative">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center mb-6">
                    <div class="bg-stone-50 p-4 rounded-xl flex flex-col justify-center items-center relative overflow-hidden">
                        <div id="statusIndicator" class="absolute left-0 top-0 h-full w-2 bg-gray-300"></div>
                        <p class="text-xs text-stone-500 uppercase tracking-wide">å½“å‰çŠ¶æ€</p>
                        <p class="text-2xl font-bold mt-1" id="statusText">æœªé¥®ç”¨</p>
                        <p class="text-xs text-stone-400 mt-1">
                            æ®‹ç•™: <span id="currentLevel" class="font-bold text-[#6F4E37]">0</span> mg
                        </p>
                        <p class="text-[10px] text-stone-400 mt-2" id="focusTimeMsg">--</p>
                    </div>
                    <div class="bg-stone-50 p-4 rounded-xl border-l-4 border-emerald-400 flex flex-col justify-center items-center">
                        <p class="text-xs text-stone-500 uppercase tracking-wide">å»ºè®®å…¥ç¡æ—¶é—´</p>
                        <p class="text-3xl font-bold text-emerald-600 mt-1" id="sleepTime">--:--</p>
                        <p class="text-[10px] text-stone-400">é™è‡³ 50mg ä»¥ä¸‹</p>
                    </div>
                </div>

                <div class="relative h-72 w-full">
                    <canvas id="caffeineChart"></canvas>
                </div>
                
                <div class="flex items-center justify-center gap-4 mt-3 text-[10px] text-stone-400">
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-green-100 border border-green-200"></div> æœ€ä½³æç¥åŒº</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-1 bg-[#6F4E37]"></div> ä½ çš„æµ“åº¦æ›²çº¿</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-1 border-t-2 border-dashed border-emerald-500"></div> ç¡çœ é˜ˆå€¼</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let drinks = [];
        let currentMode = 'mg'; 
        const today = new Date();
        today.setHours(0,0,0,0);
        const STORAGE_KEY = 'caffeine_tracker_data';

        const now = new Date();
        document.getElementById('drinkTime').value = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        
        document.getElementById('halfLife').addEventListener('input', (e) => {
            document.getElementById('halfLifeDisplay').textContent = e.target.value + 'h';
            saveData();
            if(drinks.length > 0) updateAnalysis();
        });

        // å¯åŠ¨æ—¶åŠ è½½æ•°æ®
        loadData();

        function syncSliders(source) {
            const minSlider = document.getElementById('minFocusSlider');
            const maxSlider = document.getElementById('maxFocusSlider');
            let minVal = parseInt(minSlider.value);
            let maxVal = parseInt(maxSlider.value);

            if (minVal > maxVal) {
                if (source === 'min') { maxSlider.value = minVal; maxVal = minVal; } 
                else { minSlider.value = maxVal; minVal = maxVal; }
            }

            document.getElementById('minFocus').value = minVal;
            document.getElementById('maxFocus').value = maxVal;
            document.getElementById('lblMinInput').innerText = minVal;
            document.getElementById('lblMaxInput').innerText = maxVal;

            const visualScale = 500;
            const leftPct = (minVal / visualScale) * 100;
            const widthPct = ((maxVal - minVal) / visualScale) * 100;
            
            const bar = document.getElementById('visualZoneBar');
            bar.style.left = leftPct + '%';
            bar.style.width = widthPct + '%';

            saveData();
            if(drinks.length > 0) updateAnalysis();
        }

        // --- æ•°æ®æŒä¹…åŒ– (LocalStorage) ---
        function saveData() {
            const data = {
                drinks: drinks,
                halfLife: document.getElementById('halfLife').value,
                minFocus: document.getElementById('minFocus').value,
                maxFocus: document.getElementById('maxFocus').value,
                smartSleepTime: document.getElementById('smartSleepTime').value,
                smartFocusEndTime: document.getElementById('smartFocusEndTime').value,
                smartDrinkVolume: document.getElementById('smartDrinkVolume').value,
                smartDrinkType: document.getElementById('smartDrinkType').value
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    // æ¢å¤è®¾ç½®
                    if(data.halfLife) {
                        document.getElementById('halfLife').value = data.halfLife;
                        document.getElementById('halfLifeDisplay').textContent = data.halfLife + 'h';
                    }
                    
                    if(data.minFocus && data.maxFocus) {
                        document.getElementById('minFocusSlider').value = data.minFocus;
                        document.getElementById('maxFocusSlider').value = data.maxFocus;
                        // è§¦å‘åŒæ­¥é€»è¾‘æ¥æ›´æ–°ç•Œé¢
                        syncSliders('init'); 
                    }

                    if(data.smartSleepTime) document.getElementById('smartSleepTime').value = data.smartSleepTime;
                    if(data.smartFocusEndTime) document.getElementById('smartFocusEndTime').value = data.smartFocusEndTime;
                    if(data.smartDrinkVolume) document.getElementById('smartDrinkVolume').value = data.smartDrinkVolume;
                    if(data.smartDrinkType) document.getElementById('smartDrinkType').value = data.smartDrinkType;

                    // æ¢å¤åˆ—è¡¨
                    if (data.drinks && Array.isArray(data.drinks)) {
                        drinks = data.drinks.map(d => ({
                            ...d,
                            time: new Date(d.time) // å°†å­—ç¬¦ä¸²è½¬å› Date å¯¹è±¡
                        }));
                        if (drinks.length > 0) {
                            renderList();
                            updateAnalysis();
                        }
                    }
                    
                    // é‡æ–°è®¡ç®—æ™ºèƒ½è§„åˆ’çš„æ˜¾ç¤ºå€¼
                    calcSmartDose();

                } catch (e) {
                    console.error("æ•°æ®åŠ è½½å¤±è´¥", e);
                }
            } else {
                // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆå§‹åŒ–æ»‘å—æ˜¾ç¤º
                syncSliders('init');
            }
        }


        // --- æ™ºèƒ½è¡¥å’–è®¡ç®—é€»è¾‘ ---
        function calcSmartDose() {
            const ratio = parseFloat(document.getElementById('smartDrinkType').value);
            const volume = parseFloat(document.getElementById('smartDrinkVolume').value) || 0;
            const estimated = Math.round(volume * ratio);
            document.getElementById('smartDoseDisplay').textContent = estimated;
        }

        // --- Toast & Modal ---
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            const toastIcon = document.getElementById('toastIcon');
            
            toastMsg.textContent = msg;
            toastIcon.textContent = isError ? 'âš ï¸' : 'âœ…';
            toast.classList.remove('hidden');
            toast.classList.remove('toast-exit', 'toast-exit-active');
            toast.classList.add('toast-enter');

            requestAnimationFrame(() => {
                toast.classList.add('toast-enter-active');
                toast.classList.remove('toast-enter');
            });

            setTimeout(() => {
                toast.classList.remove('toast-enter-active');
                toast.classList.add('toast-exit');
                requestAnimationFrame(() => {
                    toast.classList.add('toast-exit-active');
                    setTimeout(() => {
                        toast.classList.add('hidden');
                    }, 300);
                });
            }, 3000);
        }

        let onConfirmCallback = null;
        function showConfirm(callback) {
            onConfirmCallback = callback;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            onConfirmCallback = null;
        }

        document.getElementById('confirmActionBtn').onclick = function() {
            if (onConfirmCallback) onConfirmCallback();
            closeModal();
        }

        // ----------------------------------------

        function switchTab(mode) {
            currentMode = mode;
            ['mg', 'ml', 'powder'].forEach(m => {
                const tab = document.getElementById('tab' + m.charAt(0).toUpperCase() + m.slice(1));
                const panel = document.getElementById('mode' + m.charAt(0).toUpperCase() + m.slice(1));
                
                if (m === mode) {
                    tab.classList.add('tab-active');
                    tab.classList.remove('tab-inactive');
                    panel.classList.remove('hidden');
                } else {
                    tab.classList.add('tab-inactive');
                    tab.classList.remove('tab-active');
                    panel.classList.add('hidden');
                }
            });
        }

        // --- æ™ºèƒ½è§„åˆ’å…¥å£ ---
        function tryGenerateSmartPlan() {
            if (drinks.length === 0) {
                showToast("è¯·å…ˆåœ¨ä¸‹æ–¹æ‰‹åŠ¨æ·»åŠ ç¬¬ä¸€æ¯å’–å•¡ï¼", true);
                const section = document.getElementById('manualAddSection');
                section.scrollIntoView({ behavior: 'smooth', block: 'center' });
                section.classList.add('bg-stone-50', 'ring-2', 'ring-red-200');
                setTimeout(() => section.classList.remove('bg-stone-50', 'ring-2', 'ring-red-200'), 1000);
                return;
            }
            showConfirm(executeSmartPlan);
        }

        function executeSmartPlan() {
            drinks = drinks.filter(d => !d.isAuto);

            const minFocus = parseFloat(document.getElementById('minFocus').value) || 80;
            const fullDose = parseInt(document.getElementById('smartDoseDisplay').textContent) || 83;
            
            const sleepTimeStr = document.getElementById('smartSleepTime').value || "23:00";
            const focusTimeStr = document.getElementById('smartFocusEndTime').value || "18:00";
            const halfLife = parseFloat(document.getElementById('halfLife').value);

            // ç¡®å®šç»“æŸæ—¶é—´ç‚¹
            const lastExistingDrink = drinks[drinks.length - 1];
            
            // ç¡çœ æ—¶é—´
            let sleepDate = new Date(lastExistingDrink.time);
            const [sH, sM] = sleepTimeStr.split(':').map(Number);
            sleepDate.setHours(sH, sM, 0, 0);
            if (sleepDate < lastExistingDrink.time) sleepDate.setDate(sleepDate.getDate() + 1);

            // æç¥ç»“æŸæ—¶é—´
            let focusEndDate = new Date(lastExistingDrink.time);
            const [fH, fM] = focusTimeStr.split(':').map(Number);
            focusEndDate.setHours(fH, fM, 0, 0);
            // å¦‚æœæç¥ç»“æŸæ—¶é—´æ¯”ç¬¬ä¸€æ¯è¿˜æ—©ï¼Œè¯´æ˜æ˜¯ç¬¬äºŒå¤©ï¼Ÿé€šå¸¸ä¸ä¼šï¼Œä½†ä¸ºäº†é€»è¾‘ä¸¥å¯†
            if (focusEndDate < lastExistingDrink.time && focusEndDate.getHours() < lastExistingDrink.time.getHours()) {
                focusEndDate.setDate(focusEndDate.getDate() + 1);
            }

            let simTime = new Date(lastExistingDrink.time);
            const SLEEP_THRESHOLD = 50; 
            let addedCount = 0;

            // æˆ‘ä»¬åªè§„åˆ’åˆ°éœ€è¦ç»´æŒæç¥çš„æ—¶é—´ç‚¹ (ä¾‹å¦‚ 18:00)
            while (simTime < focusEndDate) {
                let currentLevel = calculateLevelAt(simTime, drinks, halfLife);

                if (currentLevel < minFocus) {
                    const candidateDrink = {
                        time: new Date(simTime),
                        amount: fullDose
                    };
                    
                    // 1. å°è¯•å…¨é‡
                    const potentialDrinksFull = [...drinks, candidateDrink];
                    const levelAtSleepFull = calculateLevelAt(sleepDate, potentialDrinksFull, halfLife);

                    if (levelAtSleepFull <= SLEEP_THRESHOLD) {
                        addAutoDrink(simTime, fullDose);
                    } else {
                        // 2. å…¨é‡å¤±è´¥ï¼Œå°è¯•åŠé‡ (å‡é‡è¡¥ç»™)
                        const halfDose = Math.round(fullDose * 0.5);
                        const potentialDrinksHalf = [...drinks, { time: new Date(simTime), amount: halfDose }];
                        const levelAtSleepHalf = calculateLevelAt(sleepDate, potentialDrinksHalf, halfLife);
                        
                        if (levelAtSleepHalf <= SLEEP_THRESHOLD) {
                            addAutoDrink(simTime, halfDose, true); // true for reduced
                        } else {
                            // åŠé‡ä¹Ÿä¸è¡Œï¼Œé‚£ä¸ºäº†ç¡çœ ï¼Œåªèƒ½æ­¤æ—¶ä¸å–äº†
                            // æ­¤æ—¶å¾ªç¯ç»§ç»­ï¼Œç›´åˆ° focusEndDateï¼Œå¯èƒ½åé¢æ›´ä¸èƒ½å–ï¼Œä½†è¿™ç¬¦åˆé€»è¾‘
                        }
                    }
                }
                
                simTime.setMinutes(simTime.getMinutes() + 15);
            }
            
            function addAutoDrink(time, amount, isReduced = false) {
                const newDrink = {
                    id: Date.now() + Math.random(),
                    time: new Date(time),
                    timeStr: time.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                    amount: amount,
                    isAuto: true,
                    isReduced: isReduced
                };
                drinks.push(newDrink);
                addedCount++;
            }

            drinks.sort((a, b) => a.time - b.time);
            saveData(); // ä¿å­˜ç”Ÿæˆçš„ç»“æœ
            renderList();
            updateAnalysis();
            document.getElementById('resultPanel').scrollIntoView({ behavior: 'smooth' });
            
            if (addedCount > 0) {
                showToast(`å·²è§„åˆ’ ${addedCount} æ¬¡è¡¥ç»™ (å«è‡ªåŠ¨å‡é‡)`);
            } else {
                showToast("æ— éœ€è¡¥ç»™ï¼Œæˆ–å› ç¡çœ é™åˆ¶æ— æ³•æ·»åŠ ");
            }
        }

        // è¾…åŠ©è®¡ç®—å‡½æ•°
        function calculateLevelAt(targetTime, drinksList, halfLife) {
            let total = 0;
            drinksList.forEach(d => {
                const h = (targetTime - d.time) / (1000 * 60 * 60);
                if (h >= 0) {
                    total += d.amount * Math.pow(0.5, h / halfLife);
                }
            });
            return total;
        }

        function calcFromVolume() {
            const ratio = parseFloat(document.getElementById('drinkTypeMl').value);
            const volume = parseFloat(document.getElementById('volumeInput').value) || 0;
            const estimated = Math.round(volume * ratio);
            document.getElementById('estimatedMgMl').textContent = estimated;
        }

        function calcFromPowder() {
            const ratio = parseFloat(document.getElementById('powderType').value);
            const amount = parseFloat(document.getElementById('powderInput').value) || 0;
            const estimated = Math.round(amount * ratio);
            document.getElementById('estimatedMgPowder').textContent = estimated;
        }

        function setAmount(val) {
            const input = document.getElementById('caffeineAmount');
            input.value = val;
            highlightInput(input);
        }

        function setPowder(val) {
            const input = document.getElementById('powderInput');
            input.value = val;
            calcFromPowder();
            highlightInput(input);
        }

        function highlightInput(el) {
            el.classList.add('ring-2', 'ring-[#6F4E37]');
            setTimeout(() => el.classList.remove('ring-2', 'ring-[#6F4E37]'), 200);
        }

        function addDrink() {
            const timeStr = document.getElementById('drinkTime').value;
            let amount = 0;

            if (currentMode === 'mg') {
                amount = parseFloat(document.getElementById('caffeineAmount').value);
            } else if (currentMode === 'ml') {
                const ratio = parseFloat(document.getElementById('drinkTypeMl').value);
                const volume = parseFloat(document.getElementById('volumeInput').value);
                if (isNaN(volume) || volume <= 0) { showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„æ¶²ä½“å®¹é‡", true); return; }
                amount = Math.round(volume * ratio);
            } else if (currentMode === 'powder') {
                const ratio = parseFloat(document.getElementById('powderType').value);
                const weight = parseFloat(document.getElementById('powderInput').value);
                if (isNaN(weight) || weight <= 0) { showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„ç²‰é‡", true); return; }
                amount = Math.round(weight * ratio);
            }

            if (!timeStr || isNaN(amount) || amount <= 0) { showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼", true); return; }

            const [h, m] = timeStr.split(':').map(Number);
            const drinkTime = new Date(today);
            drinkTime.setHours(h, m, 0, 0);

            const record = { id: Date.now(), time: drinkTime, timeStr: timeStr, amount: amount, isAuto: false };

            drinks.push(record);
            drinks.sort((a, b) => a.time - b.time);
            
            saveData(); // ä¿å­˜
            renderList();
            updateAnalysis();
            
            // æ¸…ç©º
            if (currentMode === 'mg') document.getElementById('caffeineAmount').value = '';
            if (currentMode === 'ml') {
                document.getElementById('volumeInput').value = '';
                document.getElementById('estimatedMgMl').textContent = '0';
            }
            if (currentMode === 'powder') {
                document.getElementById('powderInput').value = '';
                document.getElementById('estimatedMgPowder').textContent = '0';
            }
            
            showToast("æ·»åŠ æˆåŠŸï¼");
        }

        function removeDrink(id) {
            drinks = drinks.filter(d => d.id !== id);
            saveData(); // ä¿å­˜
            renderList();
            if (drinks.length === 0) {
                document.getElementById('resultPanel').classList.add('hidden');
                if (caffeineChart) caffeineChart.destroy();
            } else {
                updateAnalysis();
            }
        }

        function clearAll() {
            drinks = [];
            saveData(); // ä¿å­˜
            renderList();
            document.getElementById('resultPanel').classList.add('hidden');
            if (caffeineChart) caffeineChart.destroy();
            showToast("åˆ—è¡¨å·²æ¸…ç©º");
        }

        function renderList() {
            const listEl = document.getElementById('drinkList');
            const sectionEl = document.getElementById('drinkListSection');
            
            if (drinks.length === 0) {
                sectionEl.classList.add('hidden');
                return;
            }

            sectionEl.classList.remove('hidden');
            listEl.innerHTML = drinks.map(d => `
                <div class="flex justify-between items-center bg-white p-3 rounded shadow-sm border border-stone-100 animate-slide-in ${d.isAuto ? 'border-l-4 border-indigo-400 bg-indigo-50' : ''}">
                    <div class="flex items-center gap-3">
                        <div class="${d.isAuto ? 'bg-indigo-500' : 'bg-[#6F4E37]'} text-white text-xs px-2 py-1 rounded flex items-center gap-1">
                            ${d.timeStr} 
                            ${d.isAuto ? (d.isReduced ? '<span class="text-[9px] bg-white text-indigo-600 px-1 rounded-sm ml-1">å‡åŠ</span>' : '<span class="text-[9px] opacity-80 ml-1">è‡ªåŠ¨</span>') : ''}
                        </div>
                        <span class="font-medium text-stone-700">${d.amount} mg</span>
                    </div>
                    <button onclick="removeDrink(${d.id})" class="text-stone-400 hover:text-red-500 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        let caffeineChart = null;

        function updateAnalysis() {
            if (drinks.length === 0) return;

            document.getElementById('resultPanel').classList.remove('hidden');
            const halfLife = parseFloat(document.getElementById('halfLife').value);
            const minFocus = parseFloat(document.getElementById('minFocus').value) || 80;
            const maxFocus = parseFloat(document.getElementById('maxFocus').value) || 250;
            
            const nowTime = new Date();
            let totalCurrent = 0;
            drinks.forEach(d => {
                const hoursPassed = (nowTime - d.time) / (1000 * 60 * 60);
                if (hoursPassed >= 0) {
                    totalCurrent += d.amount * Math.pow(0.5, hoursPassed / halfLife);
                }
            });

            // é¢„æµ‹
            let safeDate = null;
            let dropsBelowMinDate = null; 
            const lastDrinkTime = drinks[drinks.length - 1].time;
            let checkTime = new Date(nowTime);
            
            let foundSleep = false;
            let foundFocusEnd = false;
            if (totalCurrent < minFocus) foundFocusEnd = true; 

            for (let i = 0; i < 288 * 2; i++) { 
                let simTotal = 0;
                drinks.forEach(d => {
                    const h = (checkTime - d.time) / (1000 * 60 * 60);
                    if (h >= 0) {
                        simTotal += d.amount * Math.pow(0.5, h / halfLife);
                    }
                });

                if (!foundSleep && simTotal <= 50) {
                    safeDate = new Date(checkTime);
                    foundSleep = true;
                }
                if (!foundFocusEnd && simTotal < minFocus) {
                    dropsBelowMinDate = new Date(checkTime);
                    foundFocusEnd = true;
                }
                if (foundSleep && foundFocusEnd) break;
                checkTime.setMinutes(checkTime.getMinutes() + 10);
            }

            document.getElementById('currentLevel').innerText = totalCurrent.toFixed(1);
            
            const statusBox = document.getElementById('statusText');
            const indicator = document.getElementById('statusIndicator');
            const focusMsg = document.getElementById('focusTimeMsg');
            
            if (totalCurrent > maxFocus) {
                statusBox.innerText = "âš ï¸ æµ“åº¦è¿‡é«˜";
                statusBox.className = "text-2xl font-bold mt-1 text-red-600";
                indicator.className = "absolute left-0 top-0 h-full w-2 bg-red-500";
                focusMsg.innerText = "å¯èƒ½å¼•èµ·ç„¦è™‘æˆ–å¿ƒæ‚¸";
            } else if (totalCurrent >= minFocus) {
                statusBox.innerText = "ğŸ§  é«˜æ•ˆæç¥ä¸­";
                statusBox.className = "text-2xl font-bold mt-1 text-green-700";
                indicator.className = "absolute left-0 top-0 h-full w-2 bg-green-500";
                
                if (dropsBelowMinDate) {
                    const tStr = dropsBelowMinDate.toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'});
                    const dayStr = dropsBelowMinDate.getDate() !== today.getDate() ? "æ¬¡æ—¥ " : "";
                    focusMsg.innerText = `é¢„è®¡ç»´æŒè‡³ ${dayStr}${tStr}`;
                } else {
                    focusMsg.innerText = "ç»´æŒæ—¶é—´å¾ˆé•¿";
                }
            } else {
                statusBox.innerText = "ğŸ“‰ æµ“åº¦è¾ƒä½";
                statusBox.className = "text-2xl font-bold mt-1 text-stone-500";
                indicator.className = "absolute left-0 top-0 h-full w-2 bg-stone-300";
                focusMsg.innerText = "æœªè¾¾æœ€ä½³æç¥åŒºé—´";
            }

            let safeText = "å·²å®‰å…¨";
            if (totalCurrent > 50) {
                if (safeDate) {
                    const isTomorrow = safeDate.getDate() !== today.getDate();
                    const timeStr = safeDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    safeText = isTomorrow ? `æ¬¡æ—¥ ${timeStr}` : timeStr;
                } else {
                    safeText = "> 48h"; 
                }
            }
            document.getElementById('sleepTime').innerText = safeText;

            updateChart(halfLife, minFocus, maxFocus);
        }

        function updateChart(halfLife, minFocus, maxFocus) {
            const ctx = document.getElementById('caffeineChart').getContext('2d');
            
            let startTime;
            if (drinks.length > 0) {
                startTime = new Date(drinks[0].time);
                startTime.setHours(startTime.getHours() - 1);
            } else {
                startTime = new Date();
                startTime.setHours(startTime.getHours() - 1);
            }
            
            const labels = [];
            const dataPoints = [];
            const sleepLine = [];
            const zoneTop = [];
            const zoneBottom = [];
            
            for (let i = 0; i <= 24; i++) { 
                const t = new Date(startTime.getTime() + i * 60 * 60 * 1000);
                labels.push(t.getHours() + ":00");
                
                let totalAtT = 0;
                drinks.forEach(d => {
                    const hoursDiff = (t - d.time) / (1000 * 60 * 60);
                    if (hoursDiff >= 0) {
                        totalAtT += d.amount * Math.pow(0.5, hoursDiff / halfLife);
                    }
                });
                
                dataPoints.push(totalAtT);
                sleepLine.push(50);
                zoneTop.push(maxFocus);
                zoneBottom.push(minFocus);
            }

            if (caffeineChart) caffeineChart.destroy();

            caffeineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ä½ çš„æµ“åº¦æ›²çº¿',
                            data: dataPoints,
                            borderColor: '#6F4E37',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            order: 1
                        },
                        {
                            label: 'ç¡çœ é˜ˆå€¼ (50mg)',
                            data: sleepLine,
                            borderColor: '#10B981',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            order: 2
                        },
                        {
                            label: 'ç„¦è™‘è­¦æˆ’',
                            data: zoneTop,
                            borderColor: 'rgba(239, 68, 68, 0.3)',
                            borderWidth: 1,
                            borderDash: [2, 2],
                            pointRadius: 0,
                            fill: false,
                            order: 3
                        },
                        {
                            label: 'æœ€ä½³æç¥åŒº',
                            data: zoneBottom,
                            borderColor: 'rgba(34, 197, 94, 0.5)',
                            borderWidth: 1,
                            borderDash: [2, 2],
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: '-1',
                            pointRadius: 0,
                            order: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    if(ctx.datasetIndex === 0) return ctx.parsed.y.toFixed(0) + ' mg (ä½“å†…)';
                                    return null;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { display: true, color: '#f5f5f4' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }
    </script>
</body>
</html>
